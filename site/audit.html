<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENTRADA-PRO • Auditoria TOP10</title>
  <style>
    :root{
      --bg:#071a2b;
      --panel:#0b2742;
      --line:#123a5e;
      --pumpkin:#ff8c00;
      --good:#00ff7f;
      --bad:#ff4d4d;
      --btn:#1f78ff;
      --muted: rgba(255,255,255,.82);
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0;color:var(--pumpkin);font-size:22px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;flex:1;min-width:260px}
    .k{color:var(--pumpkin);font-weight:800;font-size:12px;letter-spacing:.5px}
    .v{font-size:20px;margin-top:6px;font-weight:900}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px;white-space:nowrap}
    th{color:var(--pumpkin)}
    .good{color:var(--good);font-weight:900}
    .bad{color:var(--bad);font-weight:900}
    .btn{display:inline-block;background:var(--btn);color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:900}
    .note{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.35}
    details{margin-top:10px}
    summary{cursor:pointer;color:#fff;font-weight:900}
    .tag{display:inline-block;border:1px solid var(--line);padding:2px 8px;border-radius:999px;margin-left:8px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>PAINEL AUDITORIA (TOP10)</h1>
      <a class="btn" href="./top10.html">VOLTAR TOP10</a>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">
        Atualizado (BRT): <b id="updated">--</b>
        <span class="tag">Atualiza tela a cada 60s</span>
        <span class="tag">Endpoint: <span id="ep">/api/audit/summary</span></span>
      </div>
      <div class="note">
        Objetivo: mostrar <b>onde o TOP10 está performando melhor</b> (por <b>dia</b>, <b>hora</b> e <b>dia+hora</b>).
        Use isso para entender quais janelas estão mais favoráveis.
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="k">ABERTAS AGORA</div>
        <div class="v" id="open_count">--</div>
        <div class="muted">Quantidade em monitoramento</div>
      </div>

      <div class="card">
        <div class="k">TOTAL FECHADAS</div>
        <div class="v" id="total">--</div>
        <div class="muted">Base da estatística (últimos fechados)</div>
      </div>

      <div class="card">
        <div class="k">PNL MÉDIO (%)</div>
        <div class="v" id="pnl_avg">--</div>
        <div class="muted">Média do resultado real (pnl_pct_real)</div>
      </div>
    </div>

    <!-- NOVO: 3 CARDS TTL -->
    <div class="row">
      <div class="card">
        <div class="k">TTL + (PNL &gt; 0)</div>
        <div class="v" id="ttl_pos">--</div>
        <div class="muted">Expirou no TTL, mas fechou positivo</div>
      </div>

      <div class="card">
        <div class="k">TTL - (PNL &lt; 0)</div>
        <div class="v" id="ttl_neg">--</div>
        <div class="muted">Expirou no TTL, mas fechou negativo</div>
      </div>

      <div class="card">
        <div class="k">TTL 0 (PNL = 0)</div>
        <div class="v" id="ttl_zero">--</div>
        <div class="muted">Expirou no TTL, fechou zerado</div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="k">TOP 5 MELHORES JANELAS (DIA + HORA)</div>
        <table>
          <thead>
            <tr><th>Dia</th><th>Hora</th><th>N</th><th>PNL médio %</th></tr>
          </thead>
          <tbody id="best"></tbody>
        </table>
        <div class="note">Regra simples: quanto maior o <b>N</b> e o <b>PNL médio</b>, melhor.</div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="k">POR DIA DA SEMANA</div>
        <table>
          <thead><tr><th>Dia</th><th>N</th><th>PNL médio %</th></tr></thead>
          <tbody id="by_dow"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="k">POR HORA (BRT)</div>
        <table>
          <thead><tr><th>Hora</th><th>N</th><th>PNL médio %</th></tr></thead>
          <tbody id="by_hour"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="k">DETALHES (OPCIONAL)</div>
      <details>
        <summary>Ver últimos fechados (caso a caso)</summary>
        <table>
          <thead>
            <tr>
              <th>PAR</th><th>SIDE</th><th>RESULT</th><th>HIT</th><th>PNL %</th><th>ABRIU</th><th>FECHOU</th>
            </tr>
          </thead>
          <tbody id="last_closed"></tbody>
        </table>
        <div class="note">Use isso só quando precisar investigar um caso específico.</div>
      </details>
    </div>
  </div>

<script>
  const endpoint = "/api/audit/summary";

  function fmt3(n){
    if (n === null || n === undefined || isNaN(n)) return "--";
    return Number(n).toFixed(3);
  }
  function clsPNL(x){
    const v = Number(x);
    if (isNaN(v)) return "";
    return v >= 0 ? "good" : "bad";
  }
  function safe(v, fallback="--"){
    return (v === null || v === undefined || v === "") ? fallback : String(v);
  }
  function safeInt(v){
    const n = Number(v);
    return Number.isFinite(n) ? String(Math.trunc(n)) : "0";
  }

  async function load(){
    let j;
    try{
      const r = await fetch(endpoint + "?t=" + Date.now(), {cache:"no-store"});
      j = await r.json();
    }catch(e){
      document.getElementById("updated").textContent = "ERRO (API)";
      return;
    }

    document.getElementById("updated").textContent = safe(j.updated_at_brt);
    document.getElementById("open_count").textContent = safe(j.open_count);

    const overall = j.overall || {};
    document.getElementById("total").textContent = safe(overall.total);
    document.getElementById("pnl_avg").innerHTML =
      `<span class="${clsPNL(overall.pnl_avg_pct)}">${fmt3(overall.pnl_avg_pct)}</span>`;

    // TTL cards
    document.getElementById("ttl_pos").textContent = safeInt(overall.ttl_pos);
    document.getElementById("ttl_neg").textContent = safeInt(overall.ttl_neg);
    document.getElementById("ttl_zero").textContent = safeInt(overall.ttl_zero);

    // best_windows
    const best = Array.isArray(j.best_windows) ? j.best_windows : [];
    document.getElementById("best").innerHTML =
      (best.length ? best.slice(0,5).map(x => `
        <tr>
          <td>${safe(x.dow, "-")}</td>
          <td>${safe(x.hour, "-")}</td>
          <td>${safe(x.n, "-")}</td>
          <td class="${clsPNL(x.pnl_avg_pct)}">${fmt3(x.pnl_avg_pct)}</td>
        </tr>
      `).join("") : `<tr><td colspan="4" class="muted">Sem dados suficientes ainda.</td></tr>`);

    // by_dow
    const by_dow = j.by_dow || {};
    const dowKeys = Object.keys(by_dow);
    document.getElementById("by_dow").innerHTML =
      (dowKeys.length ? dowKeys.map(k => `
        <tr>
          <td>${k}</td>
          <td>${safe(by_dow[k].n, "-")}</td>
          <td class="${clsPNL(by_dow[k].pnl_avg_pct)}">${fmt3(by_dow[k].pnl_avg_pct)}</td>
        </tr>
      `).join("") : `<tr><td colspan="3" class="muted">Sem dados.</td></tr>`);

    // by_hour
    const by_hour = j.by_hour || {};
    const hourKeys = Object.keys(by_hour).sort();
    document.getElementById("by_hour").innerHTML =
      (hourKeys.length ? hourKeys.map(k => `
        <tr>
          <td>${k}:00</td>
          <td>${safe(by_hour[k].n, "-")}</td>
          <td class="${clsPNL(by_hour[k].pnl_avg_pct)}">${fmt3(by_hour[k].pnl_avg_pct)}</td>
        </tr>
      `).join("") : `<tr><td colspan="3" class="muted">Sem dados.</td></tr>`);

    // last_closed
    const lc = Array.isArray(j.last_closed) ? j.last_closed : [];
    document.getElementById("last_closed").innerHTML =
      (lc.length ? lc.map(x => `
        <tr>
          <td>${safe(x.par,"-")}</td>
          <td>${safe(x.side,"-")}</td>
          <td>${safe(x.result,"-")}</td>
          <td>${safe(x.hit,"-")}</td>
          <td class="${clsPNL(x.pnl_pct_real)}">${fmt3(x.pnl_pct_real)}</td>
          <td>${safe(x.ts_brt,"-")}</td>
          <td>${safe(x.close_ts_brt,"-")}</td>
        </tr>
      `).join("") : `<tr><td colspan="7" class="muted">Sem fechamentos recentes.</td></tr>`);
  }

  load();
  setInterval(load, 60_000);
</script>
</body>
</html>
