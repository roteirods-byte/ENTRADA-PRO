<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENTRADA-PRO • Auditoria TOP10</title>
  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#071a2b;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px;color:#ff8c00;font-size:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#0b2742;border:1px solid #123a5e;border-radius:10px;padding:12px;flex:1;min-width:260px}
    .k{color:#ff8c00;font-weight:700;font-size:12px;letter-spacing:.5px}
    .v{font-size:18px;margin-top:4px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #123a5e;padding:8px;text-align:left;font-size:13px}
    th{color:#ff8c00}
    .muted{opacity:.85}
    .good{color:#00ff7f}
    .bad{color:#ff4d4d}

    /* botões */
    .btn{display:inline-block;background:#1f78ff;color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:800}
    .btn-pumpkin{background:#ff8c00;color:#071a2b;border:1px solid #ff8c00}
    .btn-pumpkin:hover{filter:brightness(1.06)}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Auditoria TOP10</h1>
      <!-- só TOP10 (abóbora). removido FULL -->
      <a class="btn btn-pumpkin" href="top10.html">VOLTAR TOP10</a>
    </div>

    <div class="row">
      <div class="card">
        <div class="k">ATUALIZADO (BRT)</div>
        <div class="v" id="updated">--</div>
        <div class="muted" style="margin-top:6px">Endpoint: <span id="ep"></span></div>
      </div>
      <div class="card">
        <div class="k">ABERTAS AGORA</div>
        <div class="v" id="open_count">--</div>
      </div>
      <div class="card">
        <div class="k">TOTAL FECHADAS</div>
        <div class="v" id="total">--</div>
      </div>
      <div class="card">
        <div class="k">PNL MÉDIO (%)</div>
        <div class="v" id="pnl_avg">--</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card">
        <div class="k">TOP 5 MELHORES JANELAS (DIA + HORA)</div>
        <table>
          <thead><tr><th>Dia</th><th>Hora</th><th>Amostra</th><th>PNL médio %</th></tr></thead>
          <tbody id="best"></tbody>
        </table>
        <div class="muted" style="margin-top:8px">
          Regra simples: quanto maior a amostra e o PNL médio, melhor.
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card">
        <div class="k">MELHORES DIAS (DIA DA SEMANA)</div>
        <table>
          <thead><tr><th>Dia</th><th>Amostra</th><th>PNL médio %</th></tr></thead>
          <tbody id="by_dow"></tbody>
        </table>
      </div>

      <div class="card">
        <div class="k">MELHORES HORAS (BRT)</div>
        <table>
          <thead><tr><th>Hora</th><th>Amostra</th><th>PNL médio %</th></tr></thead>
          <tbody id="by_hour"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const endpoint = "/api/audit/summary";
  document.getElementById("ep").textContent = endpoint;

  function fmt(n){
    if (n === null || n === undefined || isNaN(n)) return "--";
    return Number(n).toFixed(2);
  }
  function clsPNL(x){
    const v = Number(x);
    if (isNaN(v)) return "";
    return v >= 0 ? "good" : "bad";
  }

  async function load(){
    const r = await fetch(endpoint + "?t=" + Date.now(), {cache:"no-store"});
    const j = await r.json();

    document.getElementById("updated").textContent = j.updated_at_brt || "--";
    document.getElementById("open_count").textContent = (j.open_count ?? "--");

    const overall = j.overall || {};
    document.getElementById("total").textContent = (overall.total ?? "--");
    document.getElementById("pnl_avg").innerHTML =
      `<span class="${clsPNL(overall.pnl_avg_pct)}">${fmt(overall.pnl_avg_pct)}</span>`;

    // best_windows
    const best = Array.isArray(j.best_windows) ? j.best_windows : [];
    document.getElementById("best").innerHTML = best.map(x => `
      <tr>
        <td>${x.dow || "-"}</td>
        <td>${(x.hour || "-")}:00</td>
        <td>${x.n ?? "-"}</td>
        <td class="${clsPNL(x.pnl_avg_pct)}">${fmt(x.pnl_avg_pct)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="muted">Sem dados suficientes ainda.</td></tr>`;

    // by_dow
    const by_dow = j.by_dow || {};
    const dowKeys = Object.keys(by_dow);
    document.getElementById("by_dow").innerHTML = dowKeys.map(k => `
      <tr>
        <td>${k}</td>
        <td>${by_dow[k].n ?? "-"}</td>
        <td class="${clsPNL(by_dow[k].pnl_avg_pct)}">${fmt(by_dow[k].pnl_avg_pct)}</td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">Sem dados.</td></tr>`;

    // by_hour
    const by_hour = j.by_hour || {};
    const hourKeys = Object.keys(by_hour).sort();
    document.getElementById("by_hour").innerHTML = hourKeys.map(k => `
      <tr>
        <td>${k}:00</td>
        <td>${by_hour[k].n ?? "-"}</td>
        <td class="${clsPNL(by_hour[k].pnl_avg_pct)}">${fmt(by_hour[k].pnl_avg_pct)}</td>
      </tr>
    `).join("") || `<tr><td colspan="3" class="muted">Sem dados.</td></tr>`;
  }

  load();
  setInterval(load, 60_000);
</script>
</body>
</html>
